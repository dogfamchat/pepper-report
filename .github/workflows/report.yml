name: Report Card Checker

on:
  schedule:
    # Run 3x daily: 3:30 PM, 4:30 PM, 5:30 PM MST (school days)
    # These times are when report cards are typically posted
    - cron: "30 22 * * 1-5" # 3:30 PM MST (10:30 PM UTC), Mon-Fri
    - cron: "30 23 * * 1-5" # 4:30 PM MST (11:30 PM UTC), Mon-Fri
    - cron: "30 0 * * 2-6" # 5:30 PM MST (12:30 AM UTC), Tue-Sat (runs for Mon-Fri in MST)
  workflow_dispatch: # Allow manual trigger
    inputs:
      date:
        description: "Date to scrape (YYYY-MM-DD, defaults to today)"
        required: false
        type: string

jobs:
  scrape-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_new_report: ${{ steps.changes.outputs.has_new_report }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          fetch-depth: 0 # Full history for proper commits

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install chromium --with-deps

      - name: Load staff mapping from secret
        run: |
          cat > staff.private.json << 'EOF'
          ${{ secrets.STAFF_PRIVATE_JSON }}
          EOF
        shell: bash

      - name: Scrape report card
        id: scrape
        env:
          DAYCARE_REPORT_URL: ${{ secrets.DAYCARE_REPORT_URL }}
          DAYCARE_USERNAME: ${{ secrets.DAYCARE_USERNAME }}
          DAYCARE_PASSWORD: ${{ secrets.DAYCARE_PASSWORD }}
          CLOUDFLARE_R2_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_R2_ACCOUNT_ID }}
          CLOUDFLARE_R2_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY }}
          CLOUDFLARE_R2_SECRET_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_KEY }}
          CLOUDFLARE_R2_BUCKET: ${{ secrets.CLOUDFLARE_R2_BUCKET }}
          CLOUDFLARE_R2_PUBLIC_DOMAIN: ${{ secrets.CLOUDFLARE_R2_PUBLIC_DOMAIN }}
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            bun run scripts/scrapers/scrape-report.ts --date "${{ github.event.inputs.date }}" --verbose
          else
            bun run scripts/scrapers/scrape-report.ts --verbose
          fi

      - name: Check for new report card
        id: changes
        run: |
          # Check for both modified tracked files AND new untracked files
          if [ -z "$(git status --porcelain data/reports/ photos.json 2>/dev/null)" ]; then
            echo "has_new_report=false" >> $GITHUB_OUTPUT
          else
            echo "has_new_report=true" >> $GITHUB_OUTPUT
            echo "üìù Detected changes:"
            git status --porcelain data/reports/ photos.json 2>/dev/null || true
          fi

      - name: Update staff mapping secret if needed
        if: steps.changes.outputs.has_new_report == 'true'
        run: |
          if ! git diff --quiet staff.private.json; then
            echo "‚ö†Ô∏è  New staff members discovered!"
            echo "üìù Please update the STAFF_PRIVATE_JSON GitHub Secret with:"
            echo "---"
            cat staff.private.json
            echo "---"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_new_report == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add report cards and photos
          git add data/reports/
          git add photos.json

          # Get the date from the most recent report (sort by name for predictable ordering)
          REPORT_FILE=$(ls data/reports/*/*.json | sort -r | head -n 1)

          if [ -z "$REPORT_FILE" ]; then
            echo "Error: No report files found"
            exit 1
          fi

          REPORT_DATE=$(basename "$REPORT_FILE" .json)
          GRADE=$(jq -r '.grade' "$REPORT_FILE")

          git commit -m "$(cat <<EOF
          Add report card for ${REPORT_DATE} (Grade: ${GRADE})

          Automatically scraped and processed daycare report card.
          EOF
          )"

          git push

      - name: Send Slack notification
        if: steps.changes.outputs.has_new_report == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Get the date from the most recent report
          REPORT_FILE=$(ls data/reports/*/*.json | sort -r | head -n 1)
          REPORT_DATE=$(basename "$REPORT_FILE" .json)
          echo "Sending Slack notification for report: ${REPORT_DATE}"
          bun run scripts/notifications/slack-notify.ts --date "${REPORT_DATE}"

      - name: No new report
        if: steps.changes.outputs.has_new_report == 'false'
        run: echo "No new report card found for today"

  analyze:
    needs: scrape-report
    if: needs.scrape-report.outputs.has_new_report == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.DEPLOY_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run analysis pipeline
        run: bun run analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Commit analysis results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to analysis files
          if [ -n "$(git status --porcelain data/analysis/ data/viz/ 2>/dev/null)" ]; then
            git add data/analysis/
            git add data/viz/

            git commit -m "$(cat <<EOF
          Update analysis data

          Regenerated analysis and visualization data after new report card.
          EOF
          )"

            git push
            echo "‚úÖ Analysis data committed"
          else
            echo "‚ÑπÔ∏è  No changes to analysis data"
          fi
