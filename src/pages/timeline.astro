---

import photosData from '../../photos.json';
import {
  groupReportsByMonth,
  groupReportsByYear,
  readAllReportCards,
} from '../../scripts/analysis/report-reader';
import { formatMonth, formatShortDate } from '../../scripts/utils/date-utils';
import PhotoGallery from '../components/PhotoGallery.astro';
import Layout from '../layouts/Layout.astro';

// Read all report cards
const reports = readAllReportCards().reverse(); // Newest first

// Create a Set of dates that have photos
const datesWithPhotos = new Set(photosData.photos.map((photo) => photo.date));

const reportsByYear = groupReportsByYear(reports);
const years = Array.from(reportsByYear.keys()).sort().reverse(); // Newest first

// Create nested structure: year -> month -> reports
const yearMonthStructure = years.map((year) => {
  const yearReports = reportsByYear.get(year) || [];
  const monthsMap = groupReportsByMonth(yearReports);
  const months = Array.from(monthsMap.keys()).sort().reverse();
  return {
    year,
    months: months.map((month) => ({
      month,
      reports: monthsMap.get(month) || [],
    })),
  };
});
---

<Layout title="Timeline - Pepper's Daycare">
  <main>
    <div class="header">
      <a href="/" class="back-link">‚Üê Back to Dashboard</a>
      <div class="title-ornament">‚ú¶</div>
      <h1>Chronicle Timeline</h1>
      <div class="subtitle-wrapper">
        <div class="divider-line"></div>
        <p class="subtitle">All {reports.length} report cards from daycare</p>
        <div class="divider-line"></div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="timeline">
      {yearMonthStructure.map(({ year, months }) => (
        <>
          {/* Year header - only show if there's more than one year */}
          {years.length > 1 && (
            <div class="year-section">
              <h2 class="year-header">{year}</h2>
            </div>
          )}

          {/* Month sections within this year */}
          {months.map(({ month, reports: monthReports }) => (
            <div class="month-section">
              <h2 class="month-header">{formatMonth(month)}</h2>
              <div class="reports-list">
                {monthReports.map((report: any) => (
              <details class="report-card">
                <summary class="report-summary">
                  <div class="summary-content">
                    <div class="report-date-line">
                      <span class="report-date">
                        {formatShortDate(report.date)}
                        {datesWithPhotos.has(report.date) && (
                          <span class="photo-indicator" title="Has photo">üì∑</span>
                        )}
                      </span>
                      <span class="day-of-week">{(() => {
                        const [year, month, day] = report.date.split('-').map(Number);
                        return new Date(year, month - 1, day).toLocaleDateString('en-CA', { weekday: 'long' });
                      })()}</span>
                    </div>
                    <span class=`grade-badge grade-${report.grade.toLowerCase()}`>{report.grade}</span>
                  </div>
                  <div class="summary-preview">
                    <span class="preview-label">Staff:</span>
                    <span class="preview-text">{report.staffNames.join(', ')}</span>
                  </div>
                  <div class="summary-preview">
                    <span class="preview-label">Best part:</span>
                    <span class="preview-text">{report.bestPartOfDay}</span>
                  </div>
                  <span class="expand-icon">‚ñº</span>
                </summary>

                <div class="report-details">
                  <div class="grade-section">
                    <div class=`grade-banner grade-banner-${report.grade.toLowerCase()}`>
                      <span class="grade-letter">{report.grade}</span>
                      <span class="grade-description">{report.gradeDescription}</span>
                    </div>
                  </div>

                  <div class="detail-columns">
                    <div class="detail-section">
                      <h3>Staff</h3>
                      <p>{report.staffNames.join(', ')}</p>
                    </div>

                    <div class="detail-section">
                      <h3>Best Part of Day</h3>
                      <p class="highlight">{report.bestPartOfDay}</p>
                    </div>

                    {report.caughtBeingGood.length > 0 && (
                      <div class="detail-section">
                        <h3>Caught Being Good</h3>
                        <ul class="activity-list behavior">
                          {report.caughtBeingGood.map((behavior: string) => (
                            <li>‚ú® {behavior}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {report.ooops.length > 0 && (
                      <div class="detail-section">
                        <h3>Ooops</h3>
                        <ul class="ooops-list">
                          {report.ooops.map((ooop: string) => (
                            <li>üòÖ {ooop}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    <div class="detail-section">
                      <h3>What I Did Today</h3>
                      <ul class="activity-list activity">
                        {report.whatIDidToday.map((activity: string) => (
                          <li>üéæ {activity}</li>
                        ))}
                      </ul>
                    </div>

                    {report.trainingSkills.length > 0 && (
                      <div class="detail-section">
                        <h3>Training Skills</h3>
                        <ul class="activity-list training">
                          {report.trainingSkills.map((skill: string) => (
                            <li>üèãÔ∏è‚Äç‚ôÄÔ∏è {skill}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>

                  {report.noteworthyComments && (
                    <div class="detail-section">
                      <h3>Noteworthy Comments</h3>
                      <p class="noteworthy">{report.noteworthyComments}</p>
                    </div>
                  )}

                  <div class="detail-section">
                    <PhotoGallery date={report.date} showTitle={true} size="medium" />
                  </div>
                </div>
              </details>
                ))}
              </div>
            </div>
          ))}
        </>
      ))}
    </div>
  </main>
</Layout>

<style>
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 2rem;
  }

  .header {
    text-align: center;
    margin-bottom: 4rem;
    position: relative;
    padding: 2rem 0;
  }

  .back-link {
    display: inline-block;
    color: var(--forest);
    text-decoration: none;
    margin-bottom: 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
  }

  .back-link::before {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--gold);
    transition: width 0.3s ease;
  }

  .back-link:hover::before {
    width: 100%;
  }

  .back-link:hover {
    color: var(--burgundy);
  }

  .title-ornament {
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 0.5rem;
    animation: shimmer 3s ease-in-out infinite;
    background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-dark));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  h1 {
    font-size: 3.5rem;
    margin: 0 0 1.5rem 0;
    color: var(--burgundy);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .subtitle-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .divider-line {
    width: 80px;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--warm-gray), transparent);
  }

  .subtitle {
    font-size: 1.15rem;
    color: var(--warm-gray);
    margin: 0;
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  .timeline {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .month-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .month-header {
    color: var(--burgundy);
    font-size: 2rem;
    margin: 0;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gold);
    font-weight: 600;
    position: relative;
  }

  .month-header::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100px;
    height: 2px;
    background: var(--gradient-elegant);
  }

  .reports-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .report-card {
    background: white;
    border: 2px solid var(--cream-dark);
    transition: all 0.3s ease;
  }

  .report-card:hover {
    border-color: var(--gold);
    box-shadow: 0 8px 24px rgba(139, 38, 53, 0.12);
  }

  .report-summary {
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    list-style: none;
    position: relative;
    user-select: none;
  }

  .report-summary::-webkit-details-marker {
    display: none;
  }

  .summary-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .report-date-line {
    display: flex;
    flex-direction: column;
  }

  .report-date {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--charcoal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Cormorant Garamond', serif;
  }

  .photo-indicator {
    font-size: 1.2rem;
    opacity: 0.6;
    transform: translateY(-2px);
  }

  .day-of-week {
    font-size: 0.9rem;
    color: var(--warm-gray);
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  .grade-badge {
    padding: 0.5rem 1rem;
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    font-family: 'Cormorant Garamond', serif;
    border: 2px solid;
  }

  .grade-badge.grade-a {
    background: var(--gradient-regal);
    border-color: var(--gold);
  }

  .grade-badge.grade-b {
    background: var(--gradient-forest);
    border-color: var(--forest);
  }

  .summary-preview {
    display: flex;
    gap: 0.75rem;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
  }

  .summary-preview:last-of-type {
    margin-bottom: 0;
  }

  .preview-label {
    color: var(--forest);
    font-weight: 600;
    flex-shrink: 0;
  }

  .preview-text {
    color: var(--charcoal);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .expand-icon {
    position: absolute;
    left: 0.5rem;
    top: 1.5rem;
    color: var(--gold);
    font-size: 0.9rem;
    transition: transform 0.2s ease-in-out;
    transform: rotate(0deg);
  }

  .report-card[open] .expand-icon {
    transform: rotate(180deg);
  }

  .report-details {
    padding: 0 1.5rem 1.5rem 1.5rem;
    border-top: 1px solid var(--cream-dark);
  }

  .grade-section {
    margin-top: 1.5rem;
    margin-bottom: 2rem;
  }

  .grade-banner {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding: 1.5rem;
    color: white;
    border: 2px solid;
    position: relative;
    overflow: hidden;
  }

  .grade-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.1;
    z-index: 0;
  }

  .grade-banner-a {
    background: white;
    border-color: var(--gold);
    color: var(--charcoal);
  }

  .grade-banner-a::before {
    background: var(--gradient-regal);
  }

  .grade-banner-b {
    background: white;
    border-color: var(--forest);
    color: var(--charcoal);
  }

  .grade-banner-b::before {
    background: var(--gradient-forest);
  }

  .grade-letter {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 1;
    font-family: 'Cormorant Garamond', serif;
    background: var(--gradient-elegant);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    z-index: 1;
  }

  .grade-description {
    font-size: 1.1rem;
    flex: 1;
    position: relative;
    z-index: 1;
    font-weight: 500;
  }

  .detail-columns {
    column-count: 2;
    column-gap: 2rem;
    margin-bottom: 1.5rem;
  }

  .detail-section {
    break-inside: avoid;
    margin-bottom: 1.5rem;
  }

  .detail-section:last-child {
    margin-bottom: 0;
  }

  .detail-section h3 {
    color: var(--forest);
    font-size: 1.2rem;
    margin: 0 0 0.75rem 0;
    font-weight: 600;
    position: relative;
    padding-left: 1rem;
  }

  .detail-section h3::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 60%;
    background: var(--gold);
  }

  .detail-section p {
    margin: 0;
    color: var(--charcoal);
    line-height: 1.7;
  }

  .highlight {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--burgundy);
  }

  .noteworthy {
    background: rgba(139, 38, 53, 0.04);
    padding: 1.25rem;
    border-left: 4px solid var(--burgundy);
    font-style: italic;
    line-height: 1.7;
    color: var(--charcoal);
  }

  .activity-list, .ooops-list {
    list-style: none;
    margin: 0;
    padding-left: 0;
    color: var(--charcoal);
  }

  .activity-list li, .ooops-list li {
    margin-bottom: 0.65rem;
    line-height: 1.6;
    padding-left: 0.5rem;
  }

  .year-section {
    margin-top: 5rem;
    margin-bottom: 3rem;
  }

  .year-section:first-child {
    margin-top: 0;
  }

  .year-header {
    color: var(--burgundy);
    font-size: 3rem;
    font-weight: 700;
    text-align: center;
    margin: 0;
    padding: 2rem 2rem;
    background: white;
    border: 2px solid var(--gold);
    border-top-width: 4px;
    letter-spacing: 0.02em;
    position: relative;
  }

  .year-header::before {
    content: '‚ú¶';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--gold);
    font-size: 1.5rem;
    background: var(--cream);
    padding: 0 1rem;
  }

  @media (max-width: 768px) {
    main {
      padding: 2rem 1rem;
    }

    .header {
      padding: 1rem 0;
      margin-bottom: 2.5rem;
    }

    h1 {
      font-size: 2.5rem;
    }

    .subtitle-wrapper {
      flex-direction: column;
      gap: 0.75rem;
    }

    .divider-line {
      width: 60px;
    }

    .year-header {
      font-size: 2rem;
      padding: 1.5rem 1.5rem;
    }

    .year-section {
      margin-top: 3rem;
    }

    .month-header {
      font-size: 1.5rem;
    }

    .report-summary {
      padding: 1.25rem;
    }

    .summary-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .grade-badge {
      align-self: flex-start;
    }

    .expand-icon {
      bottom: 1.25rem;
    }

    .report-details {
      padding: 0 1.25rem 1.25rem 1.25rem;
    }

    .detail-columns {
      column-count: 1;
    }

    .grade-letter {
      font-size: 3rem;
    }

    .grade-description {
      font-size: 1rem;
    }
  }
</style>
