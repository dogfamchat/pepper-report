---































































































































































































































































import { readdirSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import PhotoGallery from '../components/PhotoGallery.astro';
import Layout from '../layouts/Layout.astro';

// Read all report cards
const reportsDir = join(process.cwd(), 'data', 'reports', '2025');
const reportFiles = readdirSync(reportsDir)
  .filter((f) => f.endsWith('.json'))
  .sort()
  .reverse(); // Newest first

const reports = reportFiles.map((filename) => {
  const filepath = join(reportsDir, filename);
  return JSON.parse(readFileSync(filepath, 'utf-8'));
});

// Format date nicely
const formatDate = (dateStr: string) => {
  const [year, month, day] = dateStr.split('-').map(Number);
  const date = new Date(year, month - 1, day);
  return date.toLocaleDateString('en-CA', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// Format short date
const formatShortDate = (dateStr: string) => {
  const [year, month, day] = dateStr.split('-').map(Number);
  const date = new Date(year, month - 1, day);
  return date.toLocaleDateString('en-CA', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
};

// Group reports by month
interface ReportCard {
  date: string;
  grade: string;
  gradeDescription: string;
  staffNames: string[];
  bestPartOfDay: string;
  noteworthyComments?: string;
  whatIDidToday: string[];
  trainingSkills: string[];
  caughtBeingGood: string[];
  ooops: string[];
}

const reportsByMonth = reports.reduce(
  (acc, report) => {
    const month = report.date.substring(0, 7); // YYYY-MM
    if (!acc[month]) {
      acc[month] = [];
    }
    acc[month].push(report);
    return acc;
  },
  {} as Record<string, ReportCard[]>,
);

const months = Object.keys(reportsByMonth);

// Format month name
const formatMonth = (monthStr: string) => {
  const [year, month] = monthStr.split('-');
  const date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, 1);
  return date.toLocaleDateString('en-CA', { month: 'long', year: 'numeric' });
};
---

<Layout title="Timeline - Pepper's Daycare">
  <main>
    <div class="header">
      <a href="/pepper-report" class="back-link">‚Üê Back to Dashboard</a>
      <h1>üìÖ Full Timeline</h1>
      <p class="subtitle">All {reports.length} report cards from daycare</p>
    </div>

    <!-- Timeline -->
    <div class="timeline">
      {months.map((month) => (
        <div class="month-section">
          <h2 class="month-header">{formatMonth(month)}</h2>
          <div class="reports-list">
            {reportsByMonth[month].map((report: any) => (
              <details class="report-card">
                <summary class="report-summary">
                  <div class="summary-content">
                    <div class="report-date-line">
                      <span class="report-date">{formatShortDate(report.date)}</span>
                      <span class="day-of-week">{(() => {
                        const [year, month, day] = report.date.split('-').map(Number);
                        return new Date(year, month - 1, day).toLocaleDateString('en-CA', { weekday: 'long' });
                      })()}</span>
                    </div>
                    <span class=`grade-badge grade-${report.grade.toLowerCase()}`>{report.grade}</span>
                  </div>
                  <div class="summary-preview">
                    <span class="preview-label">Staff:</span>
                    <span class="preview-text">{report.staffNames.join(', ')}</span>
                  </div>
                  <div class="summary-preview">
                    <span class="preview-label">Best part:</span>
                    <span class="preview-text">{report.bestPartOfDay}</span>
                  </div>
                  <span class="expand-icon">‚ñº</span>
                </summary>

                <div class="report-details">
                  <div class="grade-section">
                    <div class=`grade-banner grade-banner-${report.grade.toLowerCase()}`>
                      <span class="grade-letter">{report.grade}</span>
                      <span class="grade-description">{report.gradeDescription}</span>
                    </div>
                  </div>

                  <div class="detail-section">
                    <h3>Staff</h3>
                    <p>{report.staffNames.join(', ')}</p>
                  </div>

                  <div class="detail-section">
                    <h3>Best Part of Day</h3>
                    <p class="highlight">{report.bestPartOfDay}</p>
                  </div>

                  {report.noteworthyComments && (
                    <div class="detail-section">
                      <h3>Noteworthy Comments</h3>
                      <p class="noteworthy">{report.noteworthyComments}</p>
                    </div>
                  )}

                  <div class="detail-section">
                    <PhotoGallery date={report.date} showTitle={true} size="medium" />
                  </div>

                  <div class="detail-section">
                    <h3>What I Did Today</h3>
                    <ul class="activity-list">
                      {report.whatIDidToday.map((activity: string) => (
                        <li>{activity}</li>
                      ))}
                    </ul>
                  </div>

                  {report.trainingSkills.length > 0 && (
                    <div class="detail-section">
                      <h3>Training Skills</h3>
                      <ul class="activity-list">
                        {report.trainingSkills.map((skill: string) => (
                          <li>{skill}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {report.caughtBeingGood.length > 0 && (
                    <div class="detail-section">
                      <h3>Caught Being Good</h3>
                      <ul class="good-behavior-list">
                        {report.caughtBeingGood.map((behavior: string) => (
                          <li>‚ú® {behavior}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {report.ooops.length > 0 && (
                    <div class="detail-section">
                      <h3>Ooops</h3>
                      <ul class="ooops-list">
                        {report.ooops.map((ooop: string) => (
                          <li>{ooop}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </details>
            ))}
          </div>
        </div>
      ))}
    </div>
  </main>
</Layout>

<style>
  main {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-block;
    color: #667eea;
    text-decoration: none;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2.5rem;
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .subtitle {
    font-size: 1.1rem;
    color: #666;
    margin: 0;
  }

  .timeline {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .month-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .month-header {
    color: #667eea;
    font-size: 1.5rem;
    margin: 0;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid #667eea;
  }

  .reports-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .report-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s;
  }

  .report-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .report-card[open] {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .report-summary {
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    list-style: none;
    position: relative;
    user-select: none;
  }

  .report-summary::-webkit-details-marker {
    display: none;
  }

  .summary-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .report-date-line {
    display: flex;
    flex-direction: column;
  }

  .report-date {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
  }

  .day-of-week {
    font-size: 0.9rem;
    color: #666;
  }

  .grade-badge {
    padding: 0.35rem 0.85rem;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1rem;
    color: white;
  }

  .grade-badge.grade-a {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .grade-badge.grade-b {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .summary-preview {
    display: flex;
    gap: 0.5rem;
    font-size: 0.9rem;
    margin-bottom: 0.35rem;
  }

  .summary-preview:last-of-type {
    margin-bottom: 0;
  }

  .preview-label {
    color: #667eea;
    font-weight: 500;
    flex-shrink: 0;
  }

  .preview-text {
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .expand-icon {
    position: absolute;
    right: 1.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #667eea;
    font-size: 0.8rem;
    transition: transform 0.2s;
  }

  .report-card[open] .expand-icon {
    transform: translateY(-50%) rotate(180deg);
  }

  .report-details {
    padding: 0 1.5rem 1.5rem 1.5rem;
    border-top: 1px solid #f0f0f0;
  }

  .grade-section {
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }

  .grade-banner {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.25rem;
    border-radius: 8px;
    color: white;
  }

  .grade-banner-a {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .grade-banner-b {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .grade-letter {
    font-size: 2.5rem;
    font-weight: bold;
    line-height: 1;
  }

  .grade-description {
    font-size: 1rem;
    flex: 1;
  }

  .detail-section {
    margin-bottom: 1.25rem;
  }

  .detail-section:last-child {
    margin-bottom: 0;
  }

  .detail-section h3 {
    color: #667eea;
    font-size: 1rem;
    margin: 0 0 0.6rem 0;
  }

  .detail-section p {
    margin: 0;
    color: #333;
    line-height: 1.6;
  }

  .highlight {
    font-size: 1.05rem;
    font-weight: 500;
  }

  .noteworthy {
    background: #f9f9f9;
    padding: 0.9rem;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    font-style: italic;
  }

  .activity-list,
  .good-behavior-list,
  .ooops-list {
    margin: 0;
    padding-left: 1.5rem;
    color: #333;
  }

  .activity-list li,
  .good-behavior-list li,
  .ooops-list li {
    margin-bottom: 0.4rem;
    line-height: 1.5;
  }

  .good-behavior-list {
    list-style: none;
    padding-left: 0;
  }

  .good-behavior-list li {
    padding-left: 1.5rem;
  }

  @media (max-width: 768px) {
    main {
      padding: 1rem;
    }

    h1 {
      font-size: 2rem;
    }

    .report-summary {
      padding: 1rem;
    }

    .summary-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .grade-badge {
      align-self: flex-start;
    }

    .expand-icon {
      top: 1rem;
      transform: none;
    }

    .report-card[open] .expand-icon {
      transform: rotate(180deg);
    }

    .report-details {
      padding: 0 1rem 1rem 1rem;
    }

    .grade-letter {
      font-size: 2rem;
    }
  }
</style>
