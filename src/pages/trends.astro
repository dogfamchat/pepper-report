---

import { readFileSync } from 'node:fs';
import { join } from 'node:path';
import { formatDateNoYear, formatMonth } from '../../scripts/utils/date-utils';
import GradeCharts from '../components/GradeCharts.astro';
import Layout from '../layouts/Layout.astro';

// Load analysis data
const timelinePath = join(process.cwd(), 'data', 'viz', 'grade-timeline.json');
const timeline = JSON.parse(readFileSync(timelinePath, 'utf-8'));

const trendsPath = join(process.cwd(), 'data', 'analysis', 'aggregates', 'grade-trends.json');
const trends = JSON.parse(readFileSync(trendsPath, 'utf-8'));

// Load friend network data (may not exist if API key not configured)
let friendsData = null;
try {
  const friendsPath = join(process.cwd(), 'data', 'analysis', 'aggregates', 'top-friends.json');
  friendsData = JSON.parse(readFileSync(friendsPath, 'utf-8'));
} catch (error) {
  // Friend data not available
}

// Load activity breakdown data
let activityData = null;
try {
  const activityPath = join(
    process.cwd(),
    'data',
    'analysis',
    'aggregates',
    'activity-breakdown.json',
  );
  activityData = JSON.parse(readFileSync(activityPath, 'utf-8'));
} catch (error) {
  // Activity data not available
}

// Load activity visualization data for charts
let activityFrequencyViz = null;
let trainingFrequencyViz = null;
try {
  const vizDir = join(process.cwd(), 'data', 'viz');
  activityFrequencyViz = JSON.parse(readFileSync(join(vizDir, 'activity-frequency.json'), 'utf-8'));
  trainingFrequencyViz = JSON.parse(readFileSync(join(vizDir, 'training-frequency.json'), 'utf-8'));
} catch (error) {
  // Activity viz data not available
}

// Load behavior data and visualization
let behaviorData = null;
let behaviorTimelineViz = null;
let behaviorFrequencyViz = null;
try {
  const behaviorPath = join(
    process.cwd(),
    'data',
    'analysis',
    'aggregates',
    'behavior-trends.json',
  );
  behaviorData = JSON.parse(readFileSync(behaviorPath, 'utf-8'));

  const vizDir = join(process.cwd(), 'data', 'viz');
  behaviorTimelineViz = JSON.parse(readFileSync(join(vizDir, 'behavior-timeline.json'), 'utf-8'));
  behaviorFrequencyViz = JSON.parse(readFileSync(join(vizDir, 'behavior-frequency.json'), 'utf-8'));
} catch (error) {
  // Behavior data not available
}

// Load AI category visualization data
let aiActivityCategoriesViz = null;
let aiTrainingCategoriesViz = null;
try {
  const vizDir = join(process.cwd(), 'data', 'viz');
  aiActivityCategoriesViz = JSON.parse(
    readFileSync(join(vizDir, 'ai-activity-categories.json'), 'utf-8'),
  );
  aiTrainingCategoriesViz = JSON.parse(
    readFileSync(join(vizDir, 'ai-training-categories.json'), 'utf-8'),
  );
} catch (error) {
  // AI category viz data not available
}

// Helper function to convert snake_case category names to human-readable labels
function formatCategoryLabel(category: string): string {
  return category
    .split('_')
    .map((word) => (word === 'and' ? 'and' : word.charAt(0).toUpperCase() + word.slice(1)))
    .join(' ');
}

// Category emoji mappings
const ACTIVITY_EMOJIS: Record<string, string> = {
  Playtime: 'üéæ',
  Socialization: 'üêï',
  Rest: 'üò¥',
  Outdoor: 'üå≥',
  Training: 'üéì',
  Enrichment: 'üß©',
  'Special Event': 'üéâ',
  'Physical Skills': 'üí™',
};

const TRAINING_EMOJIS: Record<string, string> = {
  'Obedience Commands': 'üéØ',
  'Impulse Control and Focus': 'üß†',
  'Physical Skills': 'üí™',
  'Handling and Manners': 'ü§ù',
  'Advanced Training': 'üéì',
  'Fun Skills': 'üé≠',
};

let learnedActivityMappings: Record<string, string[]> = {};
let learnedTrainingMappings: Record<string, string> = {};
const activityCategoryItems: Record<string, string[]> = {};
const trainingCategoryItems: Record<string, string[]> = {};

try {
  const learnedActivityPath = join(
    process.cwd(),
    'scripts',
    'analysis',
    'learned-activity-mappings.json',
  );
  const learnedTrainingPath = join(
    process.cwd(),
    'scripts',
    'analysis',
    'learned-training-mappings.json',
  );

  learnedActivityMappings = JSON.parse(readFileSync(learnedActivityPath, 'utf-8'));
  learnedTrainingMappings = JSON.parse(readFileSync(learnedTrainingPath, 'utf-8'));

  // Build reverse mappings: category -> items
  // For activities (can have multiple categories per activity)
  for (const [activity, categories] of Object.entries(learnedActivityMappings)) {
    for (const category of categories) {
      const label = formatCategoryLabel(category);
      if (!activityCategoryItems[label]) {
        activityCategoryItems[label] = [];
      }
      activityCategoryItems[label].push(activity);
    }
  }

  // For training (single category per skill)
  for (const [skill, category] of Object.entries(learnedTrainingMappings)) {
    const label = formatCategoryLabel(category);
    if (!trainingCategoryItems[label]) {
      trainingCategoryItems[label] = [];
    }
    trainingCategoryItems[label].push(skill);
  }
} catch (error) {
  console.error('Failed to load learned mappings:', error);
}

// Calculate grade percentage
const gradeToPercent = (grade: number) => ((grade / 4.0) * 100).toFixed(0);
---

<Layout title="Grade Trends - Pepper's Daycare">
  <main>
    <div class="header">
      <a href="/pepper-report" class="back-link">‚Üê Back to Dashboard</a>
      <h1>üìä Grade Trends</h1>
      <p class="subtitle">Tracking performance over time</p>
    </div>

    <!-- Overall Statistics -->
    <div class="summary-card">
      <h2>Overall Performance</h2>
      <div class="summary-stats">
        <div class="summary-stat">
          <span class="stat-label">Average Grade</span>
          <span class="stat-value">{trends.summary.overallAverageGrade.toFixed(2)}/4.0</span>
          <span class="stat-percent">{gradeToPercent(trends.summary.overallAverageGrade)}%</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Days</span>
          <span class="stat-value">{trends.summary.totalReports}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Date Range</span>
          <span class="stat-value">{formatDateNoYear(trends.summary.dateRange.start)} - {formatDateNoYear(trends.summary.dateRange.end)}</span>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <GradeCharts timeline={timeline} trends={trends} />

    <!-- Friend Leaderboard -->
    {friendsData && friendsData.friends.length > 0 && (
      <div class="chart-card">
        <h2>üêæ Friend Leaderboard</h2>
        <div class="friends-summary">
          <p>
            Pepper has played with <strong>{friendsData.summary.uniqueFriends} different friends</strong> across {friendsData.summary.totalReportCards} report cards.
          </p>
        </div>
        <div class="friends-list">
          {friendsData.friends.map((friend: any, i: number) => (
            <div class="friend-item">
              <span class="friend-rank">{i + 1}</span>
              <div class="friend-info">
                <span class="friend-name">{friend.name}</span>
                <span class="friend-last-seen">Last seen {formatDateNoYear(friend.lastSeen)}</span>
              </div>
              <span class="friend-mentions">{friend.mentions} {friend.mentions === 1 ? 'mention' : 'mentions'}</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Activity Breakdown -->
    {activityData && (
      <div class="section-header">
        <h2>üéæ Activity Breakdown</h2>
        <p class="section-subtitle">
          Total activities: {activityData.summary.totalActivityInstances} ‚Ä¢
          Total training: {activityData.summary.totalTrainingInstances}
        </p>
      </div>
    )}

    {activityFrequencyViz && trainingFrequencyViz && (
      <div class="activity-charts-grid">
        <!-- Top Activities Bar Chart -->
        <div class="chart-card">
          <h3>Top Activities</h3>
          <canvas
            id="activityFrequencyChart"
            data-chart-config={JSON.stringify(activityFrequencyViz)}
          ></canvas>
        </div>

        <!-- Top Training Skills Bar Chart -->
        <div class="chart-card">
          <h3>Top Training Skills</h3>
          <canvas
            id="trainingFrequencyChart"
            data-chart-config={JSON.stringify(trainingFrequencyViz)}
          ></canvas>
        </div>
      </div>
    )}

    <!-- Categories Section -->
    {aiActivityCategoriesViz && aiTrainingCategoriesViz && (
      <>
        <div class="section-header">
          <h2>üìä Categories</h2>
          <p class="section-subtitle">
            {Object.keys(learnedActivityMappings).length} activities ‚Ä¢ {Object.keys(learnedTrainingMappings).length} training skills
          </p>
        </div>

        <div class="activity-charts-grid">
          <!-- Activity Categories Chart -->
          <div class="chart-card">
            <h3>
              Activity Categories
              <button class="info-icon" data-modal="aiActivityModal" title="View activity details">‚ÑπÔ∏è</button>
            </h3>
            <canvas
              id="aiActivityCategoriesChart"
              data-chart-config={JSON.stringify(aiActivityCategoriesViz)}
            ></canvas>
          </div>

          <!-- Training Categories Chart -->
          <div class="chart-card">
            <h3>
              Training Categories
              <button class="info-icon" data-modal="aiTrainingModal" title="View training details">‚ÑπÔ∏è</button>
            </h3>
            <canvas
              id="aiTrainingCategoriesChart"
              data-chart-config={JSON.stringify(aiTrainingCategoriesViz)}
            ></canvas>
          </div>
        </div>
      </>
    )}

    <!-- Behavior Tracking Section -->
    {behaviorData && behaviorTimelineViz && behaviorFrequencyViz && (
      <>
        <div class="section-header">
          <h2>üåü Behavior Tracking</h2>
          <p class="section-subtitle">
            {behaviorData.summary.totalPositiveBehaviors} positive behaviors tracked across {behaviorData.summary.totalReports} reports
          </p>
        </div>

        <!-- Behavior Summary Stats -->
        <div class="behavior-summary">
          <div class="behavior-stat positive">
            <div class="stat-label">Caught Being Good</div>
            <div class="stat-value">{behaviorData.summary.totalPositiveBehaviors}</div>
            <div class="stat-detail">
              in {behaviorData.summary.reportsWithPositive} reports ({behaviorData.summary.positivePercentage.toFixed(0)}%)
            </div>
          </div>
          <div class="behavior-stat negative">
            <div class="stat-label">Ooops Moments</div>
            <div class="stat-value">{behaviorData.summary.totalNegativeBehaviors}</div>
            <div class="stat-detail">
              in {behaviorData.summary.reportsWithNegative} reports ({behaviorData.summary.negativePercentage.toFixed(0)}%)
            </div>
          </div>
          <div class="behavior-stat ratio">
            <div class="stat-label">Positive:Negative Ratio</div>
            <div class="stat-value">
              {(behaviorData.summary.totalPositiveBehaviors / Math.max(behaviorData.summary.totalNegativeBehaviors, 1)).toFixed(1)}:1
            </div>
            <div class="stat-detail">Overwhelmingly positive!</div>
          </div>
        </div>

        <!-- Behavior Charts -->
        <div class="behavior-charts-grid">
          <!-- Behavior Timeline -->
          <div class="chart-card full-width">
            <h3>Behavior Over Time</h3>
            <canvas
              id="behaviorTimelineChart"
              data-chart-config={JSON.stringify(behaviorTimelineViz)}
            ></canvas>
          </div>

          <!-- Behavior Frequency -->
          <div class="chart-card full-width">
            <h3>All Behaviors by Frequency</h3>
            <canvas
              id="behaviorFrequencyChart"
              data-chart-config={JSON.stringify(behaviorFrequencyViz)}
            ></canvas>
          </div>
        </div>

        <!-- Top Behaviors List -->
        <div class="behavior-lists-grid">
          <div class="behavior-list positive">
            <h3>‚úÖ Most Common Positive Behaviors</h3>
            <ol>
              {behaviorData.positiveBehaviors.slice(0, 5).map((behavior: any) => (
                <li>
                  <span class="behavior-name">{behavior.name}</span>
                  <span class="behavior-count">{behavior.count} times ({behavior.percentage.toFixed(1)}%)</span>
                </li>
              ))}
            </ol>
          </div>
          <div class="behavior-list negative">
            <h3>‚ö†Ô∏è Ooops Behaviors</h3>
            <ol>
              {behaviorData.negativeBehaviors.map((behavior: any) => (
                <li>
                  <span class="behavior-name">{behavior.name}</span>
                  <span class="behavior-count">{behavior.count} times ({behavior.percentage.toFixed(1)}%)</span>
                </li>
              ))}
            </ol>
          </div>
        </div>
      </>
    )}

    <!-- Monthly Breakdown -->
    <div class="section-header">
      <h2>Monthly Performance</h2>
    </div>
    <div class="monthly-grid">
      {trends.monthly.map((month: any) => (
        <div class="month-card">
          <h3>{formatMonth(month.month)}</h3>
          <div class="month-stat">
            <span class="month-label">Average Grade</span>
            <span class="month-value">{month.averageGrade.toFixed(2)}/4.0</span>
            <span class="month-percent">{gradeToPercent(month.averageGrade)}%</span>
          </div>
          <div class="month-detail">
            <span>{month.daysAttended} days</span>
            <span>{month.gradeDistribution.A} A's, {month.gradeDistribution.B} B's</span>
          </div>
        </div>
      ))}
    </div>

    <!-- Weekly Breakdown -->
    <div class="section-header">
      <h2>Weekly Performance</h2>
    </div>
    <div class="weekly-list">
      {trends.weekly.slice().reverse().map((week: any) => (
        <div class="week-card">
          <div class="week-header">
            <span class="week-label">{week.week}</span>
            <span class="week-dates">{formatDateNoYear(week.startDate)} - {formatDateNoYear(week.endDate)}</span>
            <span class="week-grade grade-badge-{week.averageGrade === 4 ? 'a' : 'b'}">{week.averageGrade.toFixed(2)}</span>
          </div>
          <div class="week-details">
            <span>{week.daysAttended} {week.daysAttended === 1 ? 'day' : 'days'}</span>
            <span class="week-distribution">{week.gradeDistribution.A} A's, {week.gradeDistribution.B} B's</span>
          </div>
        </div>
      ))}
    </div>
  </main>

  <!-- Activity Categories Modal (dynamically generated from learned mappings) -->
  <div id="aiActivityModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2>üìä Activity Categories</h2>
      <div class="modal-body">
        {Object.entries(activityCategoryItems).map(([category, items]) => (
          <div class="category-section">
            <h3>{ACTIVITY_EMOJIS[category] || 'üìå'} {category}</h3>
            <ul>
              {items.map(item => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- Training Categories Modal (dynamically generated from learned mappings) -->
  <div id="aiTrainingModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2>üìä Training Categories</h2>
      <div class="modal-body">
        {Object.entries(trainingCategoryItems).map(([category, items]) => (
          <div class="category-section">
            <h3>{TRAINING_EMOJIS[category] || 'üìå'} {category}</h3>
            <ul>
              {items.map(item => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- Hidden data for JavaScript (category mappings from learned mappings) -->
  <script id="aiActivityCategoryData" type="application/json" set:html={JSON.stringify(activityCategoryItems)} />
  <script id="aiTrainingCategoryData" type="application/json" set:html={JSON.stringify(trainingCategoryItems)} />
</Layout>

<style>
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-block;
    color: #667eea;
    text-decoration: none;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2.5rem;
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .subtitle {
    font-size: 1.1rem;
    color: #666;
    margin: 0;
  }

  .summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .summary-card h2 {
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
  }

  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2rem;
  }

  .summary-stat {
    display: flex;
    flex-direction: column;
  }

  .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .stat-percent {
    font-size: 1rem;
    opacity: 0.8;
  }

  .section-header {
    margin: 3rem 0 1.5rem 0;
  }

  .section-header h2 {
    color: #333;
    font-size: 1.5rem;
    margin: 0;
  }

  .monthly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .month-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
  }

  .month-card h3 {
    margin: 0 0 1rem 0;
    color: #667eea;
    font-size: 1.2rem;
  }

  .month-stat {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  .month-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.25rem;
  }

  .month-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.25rem;
  }

  .month-percent {
    font-size: 0.9rem;
    color: #667eea;
    font-weight: 500;
  }

  .month-detail {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.9rem;
    color: #666;
  }

  .weekly-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .week-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 1rem 1.5rem;
  }

  .week-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .week-label {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
  }

  .week-dates {
    flex: 1;
    color: #666;
    font-size: 0.9rem;
  }

  .week-grade {
    font-weight: bold;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
  }

  .grade-badge-a {
    background: #667eea;
    color: white;
  }

  .grade-badge-b {
    background: #f093fb;
    color: white;
  }

  .week-details {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: #666;
  }

  .week-distribution {
    color: #667eea;
  }

  @media (max-width: 768px) {
    main {
      padding: 1rem;
    }

    h1 {
      font-size: 1.8rem;
    }

    .summary-card {
      padding: 1.5rem;
    }

    .summary-stats {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .stat-value {
      font-size: 1.5rem;
    }

    .monthly-grid {
      grid-template-columns: 1fr;
    }

    .week-header {
      flex-wrap: wrap;
    }

    .week-dates {
      flex: none;
      width: 100%;
      order: -1;
      margin-bottom: 0.5rem;
    }

    .chart-card {
      padding: 1.5rem;
    }

    .chart-card h2 {
      font-size: 1.2rem;
    }

    .friends-list {
      gap: 0.5rem;
    }

    .friend-item {
      grid-template-columns: 30px 1fr auto;
      gap: 0.75rem;
      padding: 0.75rem;
    }

    .friend-rank {
      font-size: 1rem;
    }

    .modal-content {
      margin: 10% 5%;
      padding: 1.5rem;
      max-width: 95%;
    }

    .modal-body {
      grid-template-columns: 1fr;
    }
  }

  .friends-summary {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(147, 51, 234, 0.05);
    border-radius: 8px;
  }

  .friends-summary p {
    margin: 0;
    color: #666;
    line-height: 1.6;
  }

  .friends-summary strong {
    color: #333;
  }

  .friends-list {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .friend-item {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
  }

  .friend-rank {
    font-weight: bold;
    color: #9333ea;
    text-align: center;
    font-size: 1.1rem;
  }

  .friend-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .friend-name {
    font-weight: 500;
    color: #333;
    font-size: 1rem;
  }

  .friend-last-seen {
    font-size: 0.85rem;
    color: #666;
  }

  .friend-mentions {
    color: #9333ea;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .chart-card h2 {
    margin: 0 0 1.5rem 0;
    color: #333;
    font-size: 1.3rem;
  }

  .chart-container {
    position: relative;
    width: 100%;
    max-height: 400px;
  }

  /* Activity charts grid */
  .activity-charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .section-subtitle {
    font-size: 0.95rem;
    color: #666;
    margin: 0.5rem 0 0 0;
    font-weight: normal;
  }

  /* Give horizontal bar charts more height for readability */
  .activity-charts-grid .chart-card {
    min-height: 400px;
  }

  /* Info icon button */
  .info-icon {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
    opacity: 0.6;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
  }

  .modal.active {
    display: block;
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 12px;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  .modal-close {
    position: absolute;
    right: 1.5rem;
    top: 1.5rem;
    font-size: 2rem;
    font-weight: bold;
    color: #999;
    cursor: pointer;
    line-height: 1;
  }

  .modal-close:hover {
    color: #333;
  }

  .modal-content h2 {
    margin: 0 0 1.5rem 0;
    color: #333;
  }

  .modal-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .category-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
  }

  .category-section h3 {
    margin: 0 0 0.75rem 0;
    color: #555;
    font-size: 1rem;
  }

  .category-section ul {
    margin: 0;
    padding-left: 1.5rem;
    list-style: disc;
  }

  .category-section li {
    color: #666;
    margin-bottom: 0.4rem;
    font-size: 0.9rem;
  }

  /* Responsive grid for mobile */
  @media (max-width: 768px) {
    .activity-charts-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }

  /* Behavior Tracking Styles */
  .behavior-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .behavior-stat {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .behavior-stat.positive {
    border-left: 4px solid #22c55e;
  }

  .behavior-stat.negative {
    border-left: 4px solid #ef4444;
  }

  .behavior-stat.ratio {
    border-left: 4px solid #667eea;
  }

  .behavior-stat .stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .behavior-stat .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .behavior-stat .stat-detail {
    font-size: 0.85rem;
    color: #888;
  }

  .behavior-charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .behavior-charts-grid .full-width {
    grid-column: 1 / -1;
  }

  .behavior-lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .behavior-list {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .behavior-list.positive {
    border-left: 4px solid #22c55e;
  }

  .behavior-list.negative {
    border-left: 4px solid #ef4444;
  }

  .behavior-list h3 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: #333;
  }

  .behavior-list ol {
    margin: 0;
    padding-left: 1.5rem;
  }

  .behavior-list li {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .behavior-list li:last-child {
    border-bottom: none;
  }

  .behavior-name {
    flex: 1;
    color: #333;
    font-weight: 500;
  }

  .behavior-count {
    color: #666;
    font-size: 0.9rem;
    margin-left: 1rem;
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .behavior-charts-grid {
      grid-template-columns: 1fr;
    }

    .behavior-lists-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  import { Chart, registerables } from 'chart.js';

  // Register Chart.js components
  Chart.register(...registerables);

  // Initialize activity frequency chart
  const activityFrequencyCanvas = document.getElementById('activityFrequencyChart') as HTMLCanvasElement | null;
  if (activityFrequencyCanvas) {
    const configStr = activityFrequencyCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      new Chart(activityFrequencyCanvas, config);
    }
  }

  // Initialize training frequency chart
  const trainingFrequencyCanvas = document.getElementById('trainingFrequencyChart') as HTMLCanvasElement | null;
  if (trainingFrequencyCanvas) {
    const configStr = trainingFrequencyCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      new Chart(trainingFrequencyCanvas, config);
    }
  }

  // Initialize behavior timeline chart
  const behaviorTimelineCanvas = document.getElementById('behaviorTimelineChart') as HTMLCanvasElement | null;
  if (behaviorTimelineCanvas) {
    const configStr = behaviorTimelineCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      new Chart(behaviorTimelineCanvas, config);
    }
  }

  // Initialize behavior frequency chart
  const behaviorFrequencyCanvas = document.getElementById('behaviorFrequencyChart') as HTMLCanvasElement | null;
  if (behaviorFrequencyCanvas) {
    const configStr = behaviorFrequencyCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      new Chart(behaviorFrequencyCanvas, config);
    }
  }

  // AI category to items mappings (dynamically loaded from learned mappings in frontmatter)
  const aiActivityCategoryItems = JSON.parse(document.getElementById('aiActivityCategoryData')?.textContent || '{}');
  const aiTrainingCategoryItems = JSON.parse(document.getElementById('aiTrainingCategoryData')?.textContent || '{}');

  // Initialize AI activity categories chart
  const aiActivityCategoriesCanvas = document.getElementById('aiActivityCategoriesChart') as HTMLCanvasElement | null;
  if (aiActivityCategoriesCanvas) {
    const configStr = aiActivityCategoriesCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      config.options.plugins.tooltip.callbacks = config.options.plugins.tooltip.callbacks || {};
      config.options.plugins.tooltip.callbacks.afterLabel = function(context: any) {
        const label = context.label as string;
        const items = aiActivityCategoryItems[label as keyof typeof aiActivityCategoryItems] || [];
        return items.map((item: string) => '‚Ä¢ ' + item);
      };
      new Chart(aiActivityCategoriesCanvas, config);
    }
  }

  // Initialize AI training categories chart
  const aiTrainingCategoriesCanvas = document.getElementById('aiTrainingCategoriesChart') as HTMLCanvasElement | null;
  if (aiTrainingCategoriesCanvas) {
    const configStr = aiTrainingCategoriesCanvas.dataset.chartConfig;
    if (configStr) {
      const config = JSON.parse(configStr);
      config.options = config.options || {};
      config.options.animation = false;
      config.options.plugins = config.options.plugins || {};
      config.options.plugins.tooltip = config.options.plugins.tooltip || {};
      config.options.plugins.tooltip.animation = false;
      config.options.plugins.tooltip.callbacks = config.options.plugins.tooltip.callbacks || {};
      config.options.plugins.tooltip.callbacks.afterLabel = function(context: any) {
        const label = context.label as string;
        const items = aiTrainingCategoryItems[label as keyof typeof aiTrainingCategoryItems] || [];
        return items.map((item: string) => '‚Ä¢ ' + item);
      };
      new Chart(aiTrainingCategoriesCanvas, config);
    }
  }

  // Modal functionality
  const infoButtons = document.querySelectorAll('.info-icon');
  const modals = document.querySelectorAll('.modal');
  const closeButtons = document.querySelectorAll('.modal-close');

  // Open modal
  infoButtons.forEach(button => {
    button.addEventListener('click', () => {
      const modalId = (button as HTMLElement).dataset.modal;
      if (modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
      }
    });
  });

  // Close modal
  closeButtons.forEach(button => {
    button.addEventListener('click', () => {
      const modal = button.closest('.modal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }
    });
  });

  // Close modal when clicking outside
  modals.forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }
    });
  });

  // Close modal on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      modals.forEach(modal => {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      });
    }
  });
</script>
