---































































































































































































































































































































































































































































































































import { readFileSync } from 'node:fs';
import { join } from 'node:path';
import GradeCharts from '../components/GradeCharts.astro';
import Layout from '../layouts/Layout.astro';

// Load analysis data
const timelinePath = join(process.cwd(), 'data', 'viz', 'grade-timeline.json');
const timeline = JSON.parse(readFileSync(timelinePath, 'utf-8'));

const trendsPath = join(process.cwd(), 'data', 'analysis', 'aggregates', 'grade-trends.json');
const trends = JSON.parse(readFileSync(trendsPath, 'utf-8'));

// Load friend network data (may not exist if API key not configured)
let friendsData = null;
try {
  const friendsPath = join(process.cwd(), 'data', 'analysis', 'aggregates', 'top-friends.json');
  friendsData = JSON.parse(readFileSync(friendsPath, 'utf-8'));
} catch (error) {
  // Friend data not available
}

// Format date for display
const formatDate = (dateStr: string) => {
  const [year, month, day] = dateStr.split('-').map(Number);
  const date = new Date(year, month - 1, day);
  return date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
};

// Format month name
const formatMonth = (monthStr: string) => {
  const [year, month] = monthStr.split('-');
  const date = new Date(parseInt(year, 10), parseInt(month, 10) - 1, 1);
  return date.toLocaleDateString('en-CA', { month: 'long', year: 'numeric' });
};

// Calculate grade percentage
const gradeToPercent = (grade: number) => ((grade / 4.0) * 100).toFixed(0);
---

<Layout title="Grade Trends - Pepper's Daycare">
  <main>
    <div class="header">
      <a href="/pepper-report" class="back-link">‚Üê Back to Dashboard</a>
      <h1>üìä Grade Trends</h1>
      <p class="subtitle">Tracking performance over time</p>
    </div>

    <!-- Overall Statistics -->
    <div class="summary-card">
      <h2>Overall Performance</h2>
      <div class="summary-stats">
        <div class="summary-stat">
          <span class="stat-label">Average Grade</span>
          <span class="stat-value">{trends.summary.overallAverageGrade.toFixed(2)}/4.0</span>
          <span class="stat-percent">{gradeToPercent(trends.summary.overallAverageGrade)}%</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Days</span>
          <span class="stat-value">{trends.summary.totalReports}</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Date Range</span>
          <span class="stat-value">{formatDate(trends.summary.dateRange.start)} - {formatDate(trends.summary.dateRange.end)}</span>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <GradeCharts timeline={timeline} trends={trends} />

    <!-- Friend Leaderboard -->
    {friendsData && friendsData.friends.length > 0 && (
      <div class="chart-card">
        <h2>üêæ Friend Leaderboard</h2>
        <div class="friends-summary">
          <p>
            Pepper has played with <strong>{friendsData.summary.uniqueFriends} different friends</strong> across {friendsData.summary.totalReportCards} report cards.
          </p>
        </div>
        <div class="friends-list">
          {friendsData.friends.map((friend: any, i: number) => (
            <div class="friend-item">
              <span class="friend-rank">{i + 1}</span>
              <div class="friend-info">
                <span class="friend-name">{friend.name}</span>
                <span class="friend-last-seen">Last seen {formatDate(friend.lastSeen)}</span>
              </div>
              <span class="friend-mentions">{friend.mentions} {friend.mentions === 1 ? 'mention' : 'mentions'}</span>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Monthly Breakdown -->
    <div class="section-header">
      <h2>Monthly Performance</h2>
    </div>
    <div class="monthly-grid">
      {trends.monthly.map((month: any) => (
        <div class="month-card">
          <h3>{formatMonth(month.month)}</h3>
          <div class="month-stat">
            <span class="month-label">Average Grade</span>
            <span class="month-value">{month.averageGrade.toFixed(2)}/4.0</span>
            <span class="month-percent">{gradeToPercent(month.averageGrade)}%</span>
          </div>
          <div class="month-detail">
            <span>{month.daysAttended} days</span>
            <span>{month.gradeDistribution.A} A's, {month.gradeDistribution.B} B's</span>
          </div>
        </div>
      ))}
    </div>

    <!-- Weekly Breakdown -->
    <div class="section-header">
      <h2>Weekly Performance</h2>
    </div>
    <div class="weekly-list">
      {trends.weekly.slice().reverse().map((week: any) => (
        <div class="week-card">
          <div class="week-header">
            <span class="week-label">{week.week}</span>
            <span class="week-dates">{formatDate(week.startDate)} - {formatDate(week.endDate)}</span>
            <span class="week-grade grade-badge-{week.averageGrade === 4 ? 'a' : 'b'}">{week.averageGrade.toFixed(2)}</span>
          </div>
          <div class="week-details">
            <span>{week.daysAttended} {week.daysAttended === 1 ? 'day' : 'days'}</span>
            <span class="week-distribution">{week.gradeDistribution.A} A's, {week.gradeDistribution.B} B's</span>
          </div>
        </div>
      ))}
    </div>
  </main>
</Layout>

<style>
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-block;
    color: #667eea;
    text-decoration: none;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2.5rem;
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .subtitle {
    font-size: 1.1rem;
    color: #666;
    margin: 0;
  }

  .summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .summary-card h2 {
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
  }

  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2rem;
  }

  .summary-stat {
    display: flex;
    flex-direction: column;
  }

  .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .stat-percent {
    font-size: 1rem;
    opacity: 0.8;
  }

  .section-header {
    margin: 3rem 0 1.5rem 0;
  }

  .section-header h2 {
    color: #333;
    font-size: 1.5rem;
    margin: 0;
  }

  .monthly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .month-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .month-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .month-card h3 {
    margin: 0 0 1rem 0;
    color: #667eea;
    font-size: 1.2rem;
  }

  .month-stat {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  .month-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.25rem;
  }

  .month-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.25rem;
  }

  .month-percent {
    font-size: 0.9rem;
    color: #667eea;
    font-weight: 500;
  }

  .month-detail {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.9rem;
    color: #666;
  }

  .weekly-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .week-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 1rem 1.5rem;
    transition: box-shadow 0.2s;
  }

  .week-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .week-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .week-label {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
  }

  .week-dates {
    flex: 1;
    color: #666;
    font-size: 0.9rem;
  }

  .week-grade {
    font-weight: bold;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
  }

  .grade-badge-a {
    background: #667eea;
    color: white;
  }

  .grade-badge-b {
    background: #f093fb;
    color: white;
  }

  .week-details {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: #666;
  }

  .week-distribution {
    color: #667eea;
  }

  @media (max-width: 768px) {
    main {
      padding: 1rem;
    }

    h1 {
      font-size: 2rem;
    }

    .summary-stats {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .monthly-grid {
      grid-template-columns: 1fr;
    }

    .week-header {
      flex-wrap: wrap;
    }

    .week-dates {
      flex: none;
      width: 100%;
      order: -1;
      margin-bottom: 0.5rem;
    }
  }

  .friends-summary {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(147, 51, 234, 0.05);
    border-radius: 8px;
  }

  .friends-summary p {
    margin: 0;
    color: #666;
    line-height: 1.6;
  }

  .friends-summary strong {
    color: #333;
  }

  .friends-list {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .friend-item {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
    transition: background 0.2s;
  }

  .friend-item:hover {
    background: rgba(147, 51, 234, 0.05);
  }

  .friend-rank {
    font-weight: bold;
    color: #9333ea;
    text-align: center;
    font-size: 1.1rem;
  }

  .friend-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .friend-name {
    font-weight: 500;
    color: #333;
    font-size: 1rem;
  }

  .friend-last-seen {
    font-size: 0.85rem;
    color: #666;
  }

  .friend-mentions {
    color: #9333ea;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .chart-card h2 {
    margin: 0 0 1.5rem 0;
    color: #333;
    font-size: 1.3rem;
  }

  .chart-container {
    position: relative;
    width: 100%;
    max-height: 400px;
  }
</style>

